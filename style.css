// JOGO DA VELHA - N√çVEIS DE IA + PLACAR
let tabuleiro = Array(9).fill(null);
let jogoAtivo = false;
let nomeJogador = "Jogador 1";
let simboloJogador = 'X';
let simboloIA = 'O';
let nivelIA = 'dificil';  // ‚Üê NOVO: n√≠vel atual

// Placar (salvo no navegador)
let placar = { vitoriasJogador: 0, vitoriasIA: 0, empates: 0 };

// Elementos
const entrada = document.getElementById("entrada");
const inputNome = document.getElementById("player1");
const selectNivel = document.getElementById("nivelSelect");
const btnIniciar = document.getElementById("startBtn");
const statusTexto = document.getElementById("status");
const placarEl = document.getElementById("placar");
const vitoriasJ = document.getElementById("vitoriasJogador");
const vitoriasIAEl = document.getElementById("vitoriasIA");
const empatesEl = document.getElementById("empates");
const btnReiniciar = document.getElementById("restart");
const casas = document.querySelectorAll(".cell");
const labelJogador = document.getElementById("humanLabel");
const labelIA = document.getElementById("aiLabel");

// Combina√ß√µes vencedoras
const vitorias = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];

// Carrega placar salvo
function carregarPlacar() {
  const salvo = localStorage.getItem('jogoVelhaPlacar');
  if (salvo) placar = JSON.parse(salvo);
  atualizarPlacar();
}

function salvarPlacar() {
  localStorage.setItem('jogoVelhaPlacar', JSON.stringify(placar));
}

function atualizarPlacar() {
  vitoriasJ.textContent = placar.vitoriasJogador;
  vitoriasIAEl.textContent = placar.vitoriasIA;
  empatesEl.textContent = placar.empates;
}

// Iniciar
function iniciarPartida() {
  nomeJogador = inputNome.value.trim() || "Jogador 1";
  nivelIA = selectNivel.value;

  labelJogador.textContent = nomeJogador + " (X)";
  labelIA.textContent = `IA ${nivelIA.charAt(0).toUpperCase() + nivelIA.slice(1)} (O)`;

  entrada.classList.add("hidden");
  placarEl.classList.remove("hidden");

  limparTudo();
  jogoAtivo = true;
  statusTexto.textContent = `Vez de ${nomeJogador} (X)`;
}

// Cliques e jogadas b√°sicas (igual antes)
function clicouNaCasa(e) {
  const indice = Number(e.target.dataset.index);
  if (!jogoAtivo || tabuleiro[indice] !== null) return;

  fazerJogada(indice, simboloJogador);
  if (verificarFimDeJogo(simboloJogador, nomeJogador, true)) return;  // true = jogador ganhou

  jogoAtivo = false;
  statusTexto.textContent = "IA pensando...";
  setTimeout(jogadaDaIA, 400 + Math.random() * 300);  // delay vari√°vel
}

function fazerJogada(pos, simbolo) {
  tabuleiro[pos] = simbolo;
  const celula = casas[pos];
  celula.textContent = simbolo;
  celula.classList.add(simbolo.toLowerCase(), "ocupada");
}

function verificarFimDeJogo(simbolo, nome, ehJogador) {
  if (teveVencedor(simbolo)) {
    pintarVencedor(simbolo);
    statusTexto.textContent = `${nome} ganhou! üèÜ`;
    jogoAtivo = false;
    btnReiniciar.classList.remove("hidden");
    if (ehJogador) placar.vitoriasJogador++;
    else placar.vitoriasIA++;
    salvarPlacar();
    atualizarPlacar();
    return true;
  }
  if (tabuleiro.every(c => c !== null)) {
    statusTexto.textContent = "Deu velha! üòê";
    jogoAtivo = false;
    btnReiniciar.classList.remove("hidden");
    placar.empates++;
    salvarPlacar();
    atualizarPlacar();
    return true;
  }
  return false;
}

function teveVencedor(simbolo) {
  return vitorias.some(combo => combo.every(i => tabuleiro[i] === simbolo));
}

function pintarVencedor(simbolo) {
  vitorias.forEach(combo => {
    if (combo.every(i => tabuleiro[i] === simbolo)) {
      combo.forEach(i => casas[i].classList.add("vencedor"));
    }
  });
}

function limparTudo() {
  tabuleiro.fill(null);
  casas.forEach(c => {
    c.textContent = "";
    c.classList.remove("x", "o", "ocupada", "vencedor");
  });
  btnReiniciar.classList.add("hidden");
}

function reiniciarJogo() {
  limparTudo();
  entrada.classList.remove("hidden");
  placarEl.classList.add("hidden");
  statusTexto.textContent = "Escolha dificuldade e inicie!";
  jogoAtivo = false;
}

// ===================================
// N√çVEIS DA IA (NOVO!)
// ===================================
function jogadaDaIA() {
  let posicao;
  if (nivelIA === 'facil') {
    posicao = jogadaFacil();
  } else if (nivelIA === 'medio') {
    posicao = jogadaMedia();
  } else {  // dificil
    posicao = minimax(tabuleiro, simboloIA).index;
  }

  fazerJogada(posicao, simboloIA);
  verificarFimDeJogo(simboloIA, "IA", false);

  jogoAtivo = true;
  statusTexto.textContent = `Vez de ${nomeJogador}`;
}

// F√ÅCIL: aleat√≥ria
function jogadaFacil() {
  let vazias = [];
  for (let i = 0; i < 9; i++) if (tabuleiro[i] === null) vazias.push(i);
  return vazias[Math.floor(Math.random() * vazias.length)];
}

// M√âDIO: ganha ou bloqueia primeiro
function jogadaMedia() {
  // 1. Tenta ganhar
  for (let i = 0; i < 9; i++) {
    if (tabuleiro[i] === null) {
      tabuleiro[i] = simboloIA;
      if (teveVencedor(simboloIA)) {
        tabuleiro[i] = null;  // desfaz
        return i;
      }
      tabuleiro[i] = null;
    }
  }

  // 2. Bloqueia jogador
  for (let i = 0; i < 9; i++) {
    if (tabuleiro[i] === null) {
      tabuleiro[i] = simboloJogador;
      if (teveVencedor(simboloJogador)) {
        tabuleiro[i] = null;
        return i;
      }
      tabuleiro[i] = null;
    }
  }

  // 3. Aleat√≥ria
  return jogadaFacil();
}

// DIF√çCIL: Minimax (igual antes, otimizado)
function minimax(novoTabuleiro, jogador) {
  const vazias = novoTabuleiro.reduce((acc, val, idx) => val === null ? acc.concat(idx) : acc, []);

  if (teveVencedor(simboloJogador)) return { score: -10 };
  if (teveVencedor(simboloIA)) return { score: 10 };
  if (vazias.length === 0) return { score: 0 };

  const movimentos = [];
  for (let i = 0; i < vazias.length; i++) {
    const indice = vazias[i];
    novoTabuleiro[indice] = jogador;
    const resultado = minimax(novoTabuleiro, jogador === simboloIA ? simboloJogador : simboloIA);
    movimentos.push({ index: indice, score: resultado.score });
    novoTabuleiro[indice] = null;
  }

  let melhor = jogador === simboloIA ? movimentos.reduce((prev, curr) => curr.score > prev.score ? curr : prev) :
                                     movimentos.reduce((prev, curr) => curr.score < prev.score ? curr : prev);
  return melhor;
}

// Eventos
btnIniciar.addEventListener("click", iniciarPartida);
btnReiniciar.addEventListener("click", reiniciarJogo);
casas.forEach(casa => casa.addEventListener("click", clicouNaCasa));
inputNome.addEventListener("keypress", e => { if (e.key === "Enter") iniciarPartida(); });

carregarPlacar();  // carrega placar ao abrir p√°gina
